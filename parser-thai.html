<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Parser Livescore → JSON</title>
</head>
<body>
  <h1>⚽ ดึงข้อมูลจาก Thai-Play API แล้วแปลงเป็น JSON</h1>
  <pre id="output">Loading...</pre>

  <script>
    async function parseMatches() {
      try {
        // ดึง HTML จาก endpoint
        const res = await fetch("https://api-soccer.thai-play.com/api/v4/iptv/livescore/now?token=JF6pHMnpVCRUeEsSqAAjTWA4GbGhMrpD");
        const htmlText = await res.text();

        // ใช้ DOMParser แปลง HTML เป็น DOM
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");

        const result = { matches: [], debugLog: [] };

        // หาคู่แข่งขันทั้งหมด
        const containers = doc.querySelectorAll("div.row.gy-3");
        containers.forEach(container => {
          const statusNode = container.querySelector("div.col-lg-1 div");
          const statusText = statusNode ? statusNode.textContent.trim() : "";

          // ถ้าเป็น FT → log แล้วข้าม
          if (statusText.toUpperCase() === "FT") {
            const homeTeam = container.querySelector("div.text-end p")?.textContent.trim() || "ทีมเหย้า";
            const awayTeam = container.querySelector("div.text-start p")?.textContent.trim() || "ทีมเยือน";
            result.debugLog.push(`ข้ามคู่ที่จบแล้ว (FT): ${homeTeam} vs ${awayTeam}`);
            return;
          }

          const matchTime = statusText.replace(/(\d{1,2}):(\d{2})/, "$1.$2");
          const homeTeam = container.querySelector("div.text-end p")?.textContent.trim() || "ทีมเหย้า";
          const awayTeam = container.querySelector("div.text-start p")?.textContent.trim() || "ทีมเยือน";

          const leagueNode = container.closest("div").querySelector("strong.text-uppercase");
          const leagueFull = leagueNode ? leagueNode.textContent.trim().replace("|", ":") : "ไม่ระบุลีก";

          const dateNode = container.closest("div").querySelector("b.fs-4");
          const thaiDate = dateNode ? dateNode.textContent.trim() : new Date().toLocaleDateString("th-TH");

          const streams = container.querySelectorAll("img.iam-list-tv");
          streams.forEach(stream => {
            const channel = stream.getAttribute("alt");
            let url = stream.getAttribute("data-url");
            const logo = stream.getAttribute("src");

            if (!url) return;
            url = url.replace(":443", "").replace("/dooballfree-com/", "/do-ball.com/");

            result.matches.push({
              homeTeam,
              awayTeam,
              date: thaiDate,
              time: matchTime,
              league: leagueFull,
              channel,
              logo,
              url,
              status: statusText
            });
          });
        });

        document.getElementById("output").textContent = JSON.stringify(result, null, 2);
      } catch (err) {
        document.getElementById("output").textContent = "Error: " + err;
      }
    }

    parseMatches();
  </script>
</body>
</html>
