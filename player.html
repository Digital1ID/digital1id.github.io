<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Player</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#141414; }
    .vjs-control-bar { background: rgba(0,0,0,.6); }
  </style>
</head>
<body class="text-white font-sans">

<header class="px-6 py-4">
  <a href="../movie.html" class="text-3xl font-extrabold text-red-600">
    FLIX <span class="text-white">Movie</span>
  </a>
</header>

<main class="container mx-auto px-4 mb-16">

  <div class="relative aspect-video max-w-5xl mx-auto">
    <video
      id="my-video"
      class="video-js vjs-big-play-centered rounded-lg"
      controls
      preload="auto"
      data-setup='{
        "fluid": true,
        "playbackRates": [0.5,1,1.5,2]
      }'>
      <source id="videoSource" src="" type="">
    </video>

    <button id="reloadBtn"
      class="absolute top-3 right-3 bg-red-600/70 hover:bg-red-600 px-3 py-1 rounded text-sm">
      โหลดซ้ำ
    </button>
  </div>

  <div id="videoTitle"
    class="mt-6 text-center text-xl font-bold text-red-500">
    กำลังโหลด...
  </div>

  <div id="videoPlot"
    class="mt-4 text-gray-300 max-w-4xl mx-auto text-center text-sm leading-relaxed">
  </div>

</main>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<script>
// =============================
// CONFIG
// =============================
const params = new URLSearchParams(window.location.search);
const categoryKey = params.get("file");
const movieName = decodeURIComponent(params.get("name") || "");

const videoElement = document.getElementById("my-video");
const videoSource = document.getElementById("videoSource");
const videoTitle = document.getElementById("videoTitle");
const videoPlot = document.getElementById("videoPlot");

let player;
let currentMovie;

// =============================
// LOAD MOVIE FROM JSON
// =============================
async function loadMovie() {

  if (!categoryKey || !movieName) {
    videoTitle.textContent = "ไม่พบข้อมูลหนัง";
    return;
  }

  try {
    const res = await fetch(`playlist/${categoryKey}.json`);
    const movies = await res.json();

    const movie = movies.find(m => m.name === movieName);
    if (!movie) {
      videoTitle.textContent = "ไม่พบหนังในระบบ";
      return;
    }

    currentMovie = movie;

    const videoUrl = movie.video || movie.url || movie.file;

    if (!videoUrl) {
      videoTitle.textContent = "ไม่พบไฟล์วิดีโอ";
      return;
    }

    videoSource.src = videoUrl;
    videoSource.type = videoUrl.includes(".m3u8")
      ? "application/x-mpegURL"
      : "video/mp4";

    player = videojs("my-video");

    // ตั้ง poster
    if (movie.info?.poster) {
      player.poster(movie.info.poster);
    }

    // Resume Time
    const savedTime = localStorage.getItem("resume_" + movie.name);
    player.ready(() => {
      if (savedTime) {
        player.currentTime(parseFloat(savedTime));
      }
      player.play();
    });

    // บันทึกเวลาเล่นทุก 5 วิ
    player.on("timeupdate", () => {
      if (player.currentTime() > 5) {
        localStorage.setItem(
          "resume_" + movie.name,
          player.currentTime()
        );
      }
    });

    // Continue Watching
    localStorage.setItem("lastMovie", JSON.stringify({
      name: movie.name,
      category: categoryKey,
      poster: movie.info?.poster
    }));

    // Netflix Title
    document.title = movie.name;
    videoTitle.innerHTML = `
      <div class="text-2xl font-bold text-white">
        ${movie.name}
      </div>
      <div class="text-gray-400 mt-1">
        ${movie.info?.year || ""} • ${movie.info?.sound || ""}
      </div>
    `;

    videoPlot.textContent = movie.info?.plot || "";

  } catch (err) {
    console.error(err);
    videoTitle.textContent = "โหลดข้อมูลล้มเหลว";
  }
}


// =============================
// RELOAD BUTTON
// =============================
document.getElementById("reloadBtn").addEventListener("click", e => {
  e.preventDefault();
  location.reload();
});

loadMovie();
</script>

</body>
</html>