
<pre id="output"></pre>
<script>
async function main() {
  const params = new URLSearchParams(window.location.search);
  const fileUrl = params.get("file");
  const mode = params.get("mode");

  if (!fileUrl) {
    document.body.innerText = "กรุณาระบุพารามิเตอร์ ?file=...";
    return;
  }

  const res = await fetch(fileUrl);
  const text = await res.text();
  const movies = parseM3U8(text); // ฟังก์ชัน parseM3U8 ที่คุณเขียนไว้

  if (mode === "json") {
    // ✅ ส่งออก JSON จริง ๆ
    document.body.innerText = JSON.stringify(movies);
  } else {
    document.getElementById("output").textContent = JSON.stringify(movies, null, 2);
  }
}

function parseM3U8(text) {
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
  const entries = [];
  let current = null;

  const parseAttrs = (line) => {
    const attrs = {};
    const regex = /(\w[\w-]*)="([^"]*)"/g;
    let m;
    while ((m = regex.exec(line)) !== null) {
      attrs[m[1]] = m[2];
    }
    return attrs;
  };

  const flush = () => {
    if (current && current.name && current.video) entries.push(current);
    current = null;
  };

  for (let i=0; i<lines.length; i++) {
    const line = lines[i];
    if (line.startsWith("#EXTINF")) {
      flush();
      current = {
        player: "p2p/player",
        group: "",
        name: "",
        info: "พากย์ไทย",
        poster: "",
        video: "",
        Referrer: ""
      };
      const commaIdx = line.indexOf(",");
      const header = line.slice(0, commaIdx);
      const title = line.slice(commaIdx+1).trim();
      const attrs = parseAttrs(header);
      current.group = attrs["group-title"] || "";
      current.poster = attrs["tvg-logo"] || "";
      current.name = title;
    } else if (line.startsWith("#EXTVLCOPT:http-referrer=")) {
      if (current) current.Referrer = line.replace("#EXTVLCOPT:http-referrer=","").trim();
    } else if (!line.startsWith("#")) {
      if (current) current.video = line;
    }
  }
  flush();
  return entries;
}

(async () => {
  const params = new URLSearchParams(window.location.search);
  const fileUrl = params.get("file");
  const mode = params.get("mode");

  if (!fileUrl) {
    document.getElementById("output").textContent = "กรุณาระบุพารามิเตอร์ ?file=...";
    return;
  }

  try {
    const res = await fetch(fileUrl);
    const text = await res.text();
    const movies = parseM3U8(text);

    if (mode === "json") {
      // ✅ ส่งออก JSON จริงๆ ให้ fetch() อ่านได้
      document.body.innerText = JSON.stringify(movies);
    } else {
      // แสดงผลในหน้า HTML
      document.getElementById("output").textContent = JSON.stringify(movies, null, 2);
    }
  } catch (e) {
    document.getElementById("output").textContent = "Error: " + e;
  }
})();
</script>

