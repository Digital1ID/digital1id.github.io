<!DOCTYPE html>
<html>
<head>
    <title>P2P Player</title>
    
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />

    <script src="https://cdn.jsdelivr.net/npm/hls.js@~1/dist/hls.min.js"></script>

    <script type="importmap">
      {
        "imports": {
          "p2p-media-loader-core": "https://cdn.jsdelivr.net/npm/p2p-media-loader-core@^2/dist/p2p-media-loader-core.es.min.js",
          "p2p-media-loader-hlsjs": "https://cdn.jsdelivr.net/npm/p2p-media-loader-hlsjs@^2/dist/p2p-media-loader-hlsjs.es.min.js"
        }
      }
    </script>

    <script type="module" src="https://cdn.vidstack.io/player"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #000;
        }

        media-player {
            width: 100%;
            height: 100%;
            aspect-ratio: 16/9;
            display: block;
        }
    </style>
</head>
<body>

    <media-player title="Akuma Player" playsinline>
        <media-provider>
            <media-poster class="vds-poster"></media-poster>
        </media-provider>
        <media-video-layout></media-video-layout>
    </media-player>

    <script type="module">
        import { HlsJsP2PEngine } from "p2p-media-loader-hlsjs";

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á videoId ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå .m3u8 ‡∏´‡∏£‡∏∑‡∏≠ .txt
        function convertVideoId(videoId, type = "m3u8") {
          if (!videoId) return "";
          switch (type) {
            case "txt":
              return `https://files.akuma-player.xyz/view/${videoId}.txt`;
            case "m3u8":
            default:
              return `https://files.akuma-player.xyz/view/${videoId}.m3u8`;
          }
        }

        // üîß ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ videoId ‡πÅ‡∏•‡∏∞ type ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ query string)
        const videoId = "f62825b4-c274-52d7-a79a-249630d63003";
        const type = "m3u8"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "txt" ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå .txt
        const sourceUrl = convertVideoId(videoId, type);
        const swarmId = sourceUrl.split("?")[0];

        const player = document.querySelector('media-player');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö P2P ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isP2PCapable = Hls.isSupported() && p2pml.core.isSupported();

        player.addEventListener("provider-change", (event) => {
            const provider = event.detail;

            if (provider?.type === "hls" && isP2PCapable) {
                console.log("‚úÖ Desktop/Android detected: Enabling P2P");

                const HlsWithP2P = HlsJsP2PEngine.injectMixin(window.Hls);
                provider.library = HlsWithP2P;

                provider.config = {
                    p2p: {
                        core: { 
                            swarmId: swarmId,
                            httpDownloadProbability: 0.06, 
                            httpDownloadProbabilitySkipIfPeers: true,
                        },
                        onHlsJsCreated: (hls) => {
                            hls.config.maxBufferLength = 30;
                            hls.on(Hls.Events.ERROR, (event, data) => {
                                if (data.fatal) {
                                    switch (data.type) {
                                        case Hls.ErrorTypes.NETWORK_ERROR:
                                            hls.startLoad();
                                            break;
                                        case Hls.ErrorTypes.MEDIA_ERROR:
                                            hls.recoverMediaError();
                                            break;
                                    }
                                }
                            });
                        }
                    }
                };
            } else {
                console.log("‚ö†Ô∏è Mobile/iOS detected: P2P Disabled (Using Native Playback)");
            }
        });

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ src ‡πÉ‡∏´‡πâ player
        player.src = sourceUrl;
    </script>
</body>
</html>
