<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Player</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#141414; }
  </style>
</head>

<body class="text-white font-sans">

<header class="px-6 py-4">
  <a href="../movie.html" class="text-3xl font-extrabold text-[#E50914]">
    FLIX <span class="text-white">Movie</span>
  </a>
</header>

<main class="container mx-auto px-4 mt-8 mb-16">

  <div class="relative aspect-video max-w-5xl mx-auto">
    <video
      id="my-video"
      class="video-js vjs-big-play-centered rounded-lg"
      controls
      preload="auto"
      autoplay
      data-setup='{
        "fluid": true,
        "playbackRates": [0.5,1,1.5,2]
      }'>
      <source id="videoSource" src="" type="">
    </video>

    <button id="reloadBtn"
      class="absolute top-3 right-3 bg-red-600/70 hover:bg-red-600 px-3 py-1 rounded text-sm">
      โหลดซ้ำ
    </button>
  </div>

  <div id="videoTitle"
       class="mt-6 text-center text-xl font-bold text-[#E50914]">
    กำลังโหลด...
  </div>

</main>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<script>
// =============================
// อ่าน Query
// =============================
const params = new URLSearchParams(window.location.search);
let file = params.get("file");
let name = params.get("name");

if (file) file = decodeURIComponent(file);
if (name) name = decodeURIComponent(name);

const videoSource = document.getElementById("videoSource");
const videoTitle = document.getElementById("videoTitle");

if (file) {
  videoSource.src = file;
  videoSource.type = file.includes(".m3u8")
    ? "application/x-mpegURL"
    : "video/mp4";
}

// ตั้งชื่อเรื่อง
if (name) {
  document.title = name;
  videoTitle.textContent = name;
}

// =============================
// INIT PLAYER
// =============================
const player = videojs("my-video");

// =============================
// RESUME TIME
// =============================
const resumeKey = "resume_" + (name || file);

player.ready(() => {
  const savedTime = localStorage.getItem(resumeKey);
  if (savedTime) {
    player.currentTime(parseFloat(savedTime));
  }
});

// บันทึกเวลาทุก 5 วิ
player.on("timeupdate", () => {
  const current = player.currentTime();
  const duration = player.duration();

  if (!duration) return;

  // ถ้าดูเกิน 95% ให้ล้างเวลา
  if (current / duration > 0.95) {
    localStorage.removeItem(resumeKey);
  } else if (current > 5) {
    localStorage.setItem(resumeKey, current);
  }
});

// =============================
// CONTINUE WATCHING
// =============================
if (name && file) {
  localStorage.setItem("lastMovie", JSON.stringify({
    name: name,
    file: file,
    time: Date.now()
  }));
}

// =============================
// RELOAD
// =============================
document.getElementById("reloadBtn").addEventListener("click", (e) => {
  e.preventDefault();
  location.reload();
});
</script>

</body>
</html>