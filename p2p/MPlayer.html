<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Player</title>
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#141414] text-white font-sans">

  <!-- Header -->
  <header class="bg-[#141414] shadow-lg">
    <div class="container mx-auto px-4 py-4 flex justify-start items-center">
      <h1 class="text-3xl font-extrabold text-[#E50914] tracking-wider">
        FLIX <span class="text-white">Movie</span>
      </h1>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 mt-8 mb-16">
    <div class="relative aspect-video max-w-[854px] mx-auto">
      <video
        id="my-video"
        class="video-js vjs-big-play-centered rounded-lg overflow-hidden w-full h-full"
        controls autoplay preload="auto"
        data-setup='{"fluid": true}'>
      </video>

      <!-- ปุ่ม overlay -->
      <a href="../movie.html" 
         class="absolute top-3 left-3 px-3 py-1.5 rounded-md text-sm font-semibold text-white backdrop-blur-sm bg-white/15 hover:bg-white/35 transition">
         ย้อนกลับ
      </a>
      <a href="#" id="reloadBtn" 
         class="absolute top-3 right-3 px-3 py-1.5 rounded-md text-sm font-semibold text-white backdrop-blur-sm bg-red-600/60 hover:bg-red-600/90 transition">
         โหลดซ้ำ
      </a>
    </div>

    <!-- ชื่อเรื่อง -->
    <div id="videoTitle" 
         class="w-full rounded-lg border border-gray-700 p-2 text-center mt-4 mb-4 text-lg font-bold bg-black text-[#E50914]">
         กำลังโหลด...
    </div>

    <!-- Selector ความละเอียด -->
    <div class="flex justify-center mt-4">
      <select id="qualitySelector" 
              class="px-3 py-2 rounded-md bg-gray-800 text-white border border-gray-600">
        <option value="">Auto</option>
      </select>
    </div>
  </main>

  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    let file = params.get("file");
    let name = params.get("name");

    if (file) file = decodeURIComponent(file);
    if (name) name = decodeURIComponent(name);

    const player = videojs("my-video");

    if (file) {
      player.src({ src: file, type: "application/x-mpegURL" });
      loadPlaylist(file);
    }

    if (name) {
      document.title = name;
      document.getElementById("videoTitle").textContent = name;
    }

    // ปุ่ม reload
    document.getElementById("reloadBtn").addEventListener("click", (e) => {
      e.preventDefault();
      player.src({ src: file, type: "application/x-mpegURL" });
      player.play();
    });

    // โหลด m3u8 และสร้าง selector
    async function loadPlaylist(url) {
      try {
        const res = await fetch(url);
        const text = await res.text();
        const lines = text.split("\n");
        const qualitySelector = document.getElementById("qualitySelector");
        const baseUrl = url.substring(0, url.lastIndexOf("/"));

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("#EXT-X-STREAM-INF")) {
            const resolutionMatch = lines[i].match(/RESOLUTION=(\d+x\d+)/);
            const bandwidthMatch = lines[i].match(/BANDWIDTH=(\d+)/);
            const streamUrl = lines[i+1].trim();

            if (resolutionMatch) {
              const resolution = resolutionMatch[1];
              const option = document.createElement("option");
              // ใช้ absolute URL ถ้า streamUrl เป็น relative
              option.value = streamUrl.startsWith("http") ? streamUrl : baseUrl + "/" + streamUrl.replace(/^\//, "");
              option.textContent = resolution + 
                (bandwidthMatch ? ` (${Math.round(bandwidthMatch[1]/1000)} kbps)` : "");
              qualitySelector.appendChild(option);
            }
          }
        }

        qualitySelector.addEventListener("change", (e) => {
          const value = e.target.value;
          if (value) {
            player.src({ src: value, type: "application/x-mpegURL" });
            player.play();
          } else {
            player.src({ src: url, type: "application/x-mpegURL" });
            player.play();
          }
        });
      } catch (err) {
        console.error("Error loading playlist:", err);
      }
    }
  </script>
</body>
</html>
