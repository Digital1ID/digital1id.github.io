<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Parser + JWPlayer</title>
  <style>
    body { margin:0; background:#000; width:100vw; height:100vh; display:flex; justify-content:center; align-items:center; }
    #play { width:100vw; height:100vh; }
    .switch-button, .reload-button {
      position: fixed; top: 15px; z-index: 10000; padding: 8px 12px; border-radius: 4px; font-size: 14px;
      backdrop-filter: blur(4px); color: #fff; text-decoration: none;
    }
    .switch-button { left: 20px; background-color: rgba(40,167,69,0.3); }
    .switch-button:hover { background-color: rgba(40,167,69,0.6); }
    .reload-button { right: 20px; background-color: rgba(0,123,255,0.3); }
    .reload-button:hover { background-color: rgba(0,123,255,0.6); }
    #videoTitle { position: fixed; bottom: 60px; left: 20px; color: #fff; background: rgba(0,0,0,0.5); padding: 6px 12px; border-radius: 4px; font-size: 16px; z-index: 10000; }
    .error-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:20000; }
    .error-overlay a { margin-top:10px; padding:8px 12px; border-radius:4px; background-color:rgba(40,167,69,0.3); color:#fff; text-decoration:none; }
    .error-overlay a:hover { background-color:rgba(40,167,69,0.6); }
  </style>
</head>
<body>
  <a href="#" id="switchBtn" class="switch-button">สลับ Player</a>
  <a href="#" id="reloadBtn" class="reload-button">โหลดซ้ำ</a>
  <div id="play"></div>
  <div id="videoTitle"></div>

  <script src="jw/jwplayer.js"></script>
<script>
jwplayer.key = "eNFaXCjyURVoCCGiHp7HTQ3hDhE/AfL0g8VE1fRbL84=";

const nationMap = {
  TH: "ภาพยนตร์ ไทย", KR: "ภาพยนตร์ เกาหลี", JP: "ภาพยนตร์ ญี่ปุ่น", US: "ภาพยนตร์ สหรัฐอเมริกา"
};

async function checkSubtitleExists(url) {
  try { const res = await fetch(url, { method: 'HEAD' }); return res.ok; } catch { return false; }
}
function extractAudioTracks(m3u8Text) {
  const audioTracks = []; const regex = /#EXT-X-MEDIA:TYPE=AUDIO.*?LANGUAGE="([^"]+)".*?URI="([^"]+)"/g; let match;
  while ((match = regex.exec(m3u8Text)) !== null) audioTracks.push({ language: match[1], uri: match[2] });
  return audioTracks;
}

async function fetchMovieById(movieId) {
  const query = `
    query getMovie($id: Int!) {
      movie(id: $id) {
        id titleTh titleEn descriptionTh synopsisTh releaseDate posterUrl imdbRating slug nation
        genres { name slug }
        video { transcodeUuid cdnHostname }
      }
    }
  `;
  const response = await fetch('https://api.doo-nang.com/graphql', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, variables: { id: movieId } })
  });
  const result = await response.json();
  const movie = result?.data?.movie;
  if (!movie) return null;

  const plot = movie.descriptionTh?.trim() || movie.synopsisTh?.trim() || '-';
  const year = movie.releaseDate?.substring(0,4) || "0000";
  const category = nationMap[movie.nation] || "ภาพยนตร์ ทั่วไป";

  let videoUrl = "", subtitle=[], audioTracks=[];
  const transcodeUuid = movie.video?.transcodeUuid, cdnHostname = movie.video?.cdnHostname;
  if (transcodeUuid && cdnHostname) {
    const base = `https://${cdnHostname}/${transcodeUuid}`;
    videoUrl = `https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;
    const subs = [
      { lang:"th", codec:"VTT", src:`${base}/sub_tha.vtt` },
      { lang:"en", codec:"VTT", src:`${base}/sub_eng.vtt` }
    ];
    for (const s of subs) if (await checkSubtitleExists(s.src)) subtitle.push(s);
    try { const res = await fetch(videoUrl); if (res.ok) audioTracks = extractAudioTracks(await res.text()); } catch {}
  }

  return {
    id: movie.id,
    name: `${movie.titleEn || movie.titleTh} - ${movie.titleTh || movie.titleEn}`,
    category,
    info: { poster: movie.posterUrl, plot, year },
    video: videoUrl,
    subtitle,
    audioTracks
  };
}

async function initPlayer() {
  const params = new URLSearchParams(window.location.search);
  const ids = params.get("ids");
  if (!ids) { document.getElementById("videoTitle").innerText="ไม่พบ Movie ID"; return; }
  const data = await fetchMovieById(parseInt(ids,10));
  if (!data) { document.getElementById("videoTitle").innerText="ไม่พบข้อมูล"; return; }

  document.title = data.name;
  document.getElementById("videoTitle").innerText = data.name;

  const playerConfig = {
    width:"100%", height:"100%", aspectratio:"16:9",
    playlist:[{ file:data.video, tracks:[] }],
    primary:"html5", hlshtml:true, controls:true, autostart:true
  };

  data.subtitle.forEach(sub=>{
    playerConfig.playlist[0].tracks.push({ file:sub.src, label:sub.lang.toUpperCase(), kind:"captions" });
  });
  data.audioTracks.forEach(at=>{
    playerConfig.playlist[0].tracks.push({ file:at.uri, label:at.language.toUpperCase()+" Audio", kind:"audio" });
  });

  jwplayer("play").setup(playerConfig);

  jwplayer("play").on("error", function(){
    const overlay=document.createElement("div");
    overlay.className="error-overlay";
    overlay.innerHTML=`<p>เกิดข้อผิดพลาดในการโหลดวิดีโอ</p><a href="#" id="switchBtnError">สลับ Player</a>`;
    document.body.appendChild(overlay);
    document.getElementById("switchBtnError").addEventListener("click", e=>{
      e.preventDefault();
      const newUrl=new URL(window.location.href);
      newUrl.pathname=newUrl.pathname.replace("Parser-jwplayer.html","videojs.html");
      window.location.href=newUrl.toString();
    });
  });
}

document.getElementById("reloadBtn").addEventListener("click", e=>{
  e.preventDefault(); jwplayer("play").play();
});
document.getElementById("switchBtn").addEventListener("click", e=>{
  e.preventDefault();
  const newUrl=new URL(window.location.href);
  newUrl.pathname=newUrl.pathname.replace("Parser-jwplayer.html","videojs.html");
  window.location.href=newUrl.toString();
});

window.onload=initPlayer;
</script>
</body>
</html>
